---
title: "Hourly DMC and DC in the Next-gen CFFDRS"
author: "Jordan Evens"
date: "May 31, 2023"
output:
  pdf_document: default
  html_document: default
---

# Problem
The problem with the system as proposed is that the indices calculated for an hour, at the hour that they are for, can change after the fact, depending on how the forecast matches the observations.

The issue with basing the calculations on the old daily wetting function is that it relies on 24 hours of rain. The daily system uses noon-to-noon rain, and the proposed system is using midnight-to-midnight rain. If there is a desire to change to calendar days, and the differences in how that division of rain are considered minor enough to ignore, then there is still the issue of how the wetting for the hours is divided up, and can change how much wetting is applied to a previous hour if the forecast doesn't match the "observed" weather.

It sounds like devising a new hourly wetting function based on a better physical model is extremely complicated, and beyond the current scope of the project. I believe there is a middle ground that at least resolves the issue of indices changing after they are "observed".


# Assumptions
I'm under the impression that Derek's new drying functions are going to be hourly, and that they will work in the same way as the hourly FFMC, in that to calculate the final indices for an hour, you only use the current hour's weather and the previous hour's FFMC value. As long as the new functions work in the same manner for DMC and DC, then I believe there is a way to make the wetting function act in a similar manner.


# Proposed DMC wetting
The currently proposed system works by allocating wetting based on the proportion of rain that happened during each hour.

The old DMC wetting equation boils down to:
```{r}
wetting <- function(dmc_yda, prec) {
  pr <- ifelse(
    prec <= 1.5,
    dmc_yda,
    {
      ra <- prec
      # Eq. 11 - Net rain amount
      rw <- 0.92 * ra - 1.27
      # Alteration to Eq. 12 to calculate more accurately
      wmi <- 20 + 280 / exp(0.023 * dmc_yda)
      # Eqs. 13a, 13b, 13c
      b <- ifelse(
        dmc_yda <= 33,
        100 / (0.5 + 0.3 * dmc_yda),
        ifelse(
          dmc_yda <= 65,
          14 - 1.3 * log(dmc_yda),
          6.2 * log(dmc_yda) - 17.2
        )
      )
      # Eq. 14 - Moisture content after rain
      wmr <- wmi + 1000 * rw / (48.77 + b * rw)
      # Alteration to Eq. 15 to calculate more accurately
      43.43 * (5.6348 - log(wmr - 20))
    }
  )
  # wetting is difference between yesterday's value and final total
  return(pr - dmc_yda)
}
```

e.g.

	- the DMC yesterday is any value, e.g. 60
	- There is 2mm of rain at 0800.
	- 8mm of rain is forecast for 1000.
	- No other rain is expected in the 24 hour period.

So:
```{r}
dmc_yda <- 60
prec_0800 <- 2
prec_1000 <- 8
c(dmc_yda = dmc_yda, prec_0800 = prec_0800, prec_1000 = prec_1000)
```

1) calculate how much wetting the old daily system would apply for the 24 hour period:
```{r}
prec_total <- prec_0800 + prec_1000
c(prec_total = prec_total)
```
		- in the example where DMC is 60, this results in a decrease in DMC of:
```{r}
pr_total <- wetting(dmc_yda, prec_total)
c(pr_total = pr_total)
```

2) determine what proportion of the rain happened for each hour there is rain:
```{r}
proportion_0800 <- prec_0800 / prec_total
proportion_1000 <- prec_1000 / prec_total
c(proportion_0800 = proportion_0800, proportion_1000 = proportion_1000)
```

3) proportion the total wetting across the hours with rain, according to the proportion of rain they had:
```{r}
pr_0800 <- proportion_0800 * pr_total
pr_1000 <- proportion_1000 * pr_total
c(pr_0800 = pr_0800, pr_1000 = pr_1000)
```

4) apply to the DMC (ignoring drying for now):
```{r}
dmc_0800 <- dmc_yda + pr_0800
dmc_1000 <- dmc_0800 + pr_1000
scenario_1a <- c(dmc_0800 = dmc_0800,  dmc_1000 = dmc_1000)
scenario_1a
```

So in the proposed system, (ignoring drying), you end up with a DMC of `r round(dmc_0800, 1)` at 0800 and a DMC of `r round(dmc_1000, 1)` in the forecast.

Consider what happens if the forecast doesn't pan out.

Assume 2mm of rain at 0800, but only 5mm of rain at 1000:
```{r}
prec_0800 <- 2
prec_1000 <- 5
c(dmc_yda = dmc_yda, prec_0800 = prec_0800, prec_1000 = prec_1000)
```

1) calculate how much wetting the old daily system would apply for the 24 hour period:
```{r}
prec_total <- prec_0800 + prec_1000
c(prec_total = prec_total)
```
		- in the example where DMC is 60, this results in a decrease in DMC of:
```{r}
pr_total <- wetting(dmc_yda, prec_total)
c(pr_total = pr_total)
```

2) determine what proportion of the rain happened for each hour there is rain:
```{r}
proportion_0800 <- prec_0800 / prec_total
proportion_1000 <- prec_1000 / prec_total
c(proportion_0800 = proportion_0800, proportion_1000 = proportion_1000)
```

3) proportion the total wetting across the hours with rain, according to the proportion of rain they had:
```{r}
pr_0800 <- proportion_0800 * pr_total
pr_1000 <- proportion_1000 * pr_total
c(pr_0800 = pr_0800, pr_1000 = pr_1000)
```

4) apply to the DMC (ignoring drying for now):
```{r}
dmc_0800 <- dmc_yda + pr_0800
dmc_1000 <- dmc_0800 + pr_1000
scenario_2a <- c(dmc_0800 = dmc_0800,  dmc_1000 = dmc_1000)
scenario_2a
```

So in the proposed system, (ignoring drying), the observed values become  a DMC of `r round(dmc_0800, 1)` at 0800 and a DMC of `r round(dmc_1000, 1)`. It's not a huge difference, but the important part is that the 0800 DMC changes after it has been calculated and recorded as the "observed" value - and this will happen every hour that there is rain during the 24 hour period.

Consider a more extreme example. Assume that things have proceeded as per the second scenario, but now we have also received 10mm that was not forecast at 1100.
Assume 2mm of rain at 0800, but only 5mm of rain at 1000, and 10mm at 1100:
```{r}
prec_0800 <- 2
prec_1000 <- 5
prec_1100 <- 10
c(dmc_yda = dmc_yda, prec_0800 = prec_0800, prec_1000 = prec_1000,
  prec_1100 = prec_1100)
```

1) calculate how much wetting the old daily system would apply for the 24 hour period:
```{r}
prec_total <- prec_0800 + prec_1000 + prec_1100
c(prec_total = prec_total)
```
		- in the example where DMC is 60, this results in a decrease in DMC of:
```{r}
pr_total <- wetting(dmc_yda, prec_total)
c(pr_total = pr_total)
```

2) determine what proportion of the rain happened for each hour there is rain:
```{r}
proportion_0800 <- prec_0800 / prec_total
proportion_1000 <- prec_1000 / prec_total
proportion_1100 <- prec_1100 / prec_total
c(proportion_0800 = proportion_0800, proportion_1000 = proportion_1000,
  proportion_1100 = proportion_1100)
```

3) proportion the total wetting across the hours with rain, according to the proportion of rain they had:
```{r}
pr_0800 <- proportion_0800 * pr_total
pr_1000 <- proportion_1000 * pr_total
pr_1100 <- proportion_1100 * pr_total
c(pr_0800 = pr_0800, pr_1000 = pr_1000, pr_1100 = pr_1100)
```

4) apply to the DMC (ignoring drying for now):
```{r}
dmc_0800 <- dmc_yda + pr_0800
dmc_1000 <- dmc_0800 + pr_1000
dmc_1100 <- dmc_1000 + pr_1100
scenario_3a <- c(dmc_0800 = dmc_0800,  dmc_1000 = dmc_1000, dmc_1100 = dmc_1100)
scenario_3a
```

So in this instance, the weather was exactly the same as scenario 2, up to the point at 1000. But when the 1100 weather comes in, the indices for the previous hours change:
```{r}
data.table::data.table(rbind(c(scenario_1a, dmc_1100=NA),
                             c(scenario_2a, dmc_1100=NA),
                             scenario_3a))
```

Operationally, agencies are required to justify all their decisions, in part by recording any data that were considered. If the weather indices for the past are changing throughout the day, then that is an issue.

---

Also, as another example, imagine a map.
Given:

- The entire area is starting from the same indices.
- The entire area has the same forecast indices, and there are 3 hours where rain is in the forecast.

If this scenario is mapped in the morning, you would produce 3 maps, where all of the values are the same at all of the stations.

Now, consider what happens if only half of the stations actually receive the rain for the 3rd hour. As expected, the map would have half of the stations showing one value, and half showing the other at the end of the period, because the total amount of rain is different. However, because the proportion of rain for the first two hours would change for those stations that did not receive the last amount of rain, the indices for those hours would change. This would result in a situation where the exact same starting indices, and observed weather for the first two hours, at all the stations, would result in half of the stations showing different calculated values, due to the fact that in the future more rain did or didn't happen.

---

# Alternative

I believe that there is a compromise, where we can still use the old 24 hour calculation, but make it so that the indices for an hour never change after they have been calculated.

Instead of using the forecast to determine the values for the current hour, let's do the calculations as if we expect no further rain in the 24 hour period. This will obviously have all the same accuracy issues as the old system, and may even be worse than the current proposal in that respect, but the benefit is that once numbers have been calculated, they no longer change.

So:
```{r}
dmc_yda <- 60
prec_0800 <- 2
prec_1000 <- 8
c(dmc_yda = dmc_yda, prec_0800 = prec_0800, prec_1000 = prec_1000)
```

1) calculate how much wetting the old daily system would apply for the 24 hour period, given the amount of rain that has happened up until each hour:
```{r}
pr_0800 <- wetting(dmc_yda, prec_0800)
pr_1000 <- wetting(dmc_yda, prec_0800 + prec_1000)
c(pr_0800 = pr_0800, pr_1000 = pr_1000)
```

2) apply to the DMC (ignoring drying for now):
```{r}
dmc_0800 <- dmc_yda + pr_0800
dmc_1000 <- dmc_yda + pr_1000
scenario_1b <- c(dmc_0800 = dmc_0800,  dmc_1000 = dmc_1000)
scenario_1b
```

So in this case, (ignoring drying), you end up with a DMC of `r round(dmc_0800, 1)` at 0800 and a DMC of `r round(dmc_1000, 1)` in the forecast.

Consider what happens if the forecast doesn't pan out.

Assume 2mm of rain at 0800, but only 5mm of rain at 1000:
```{r}
prec_0800 <- 2
prec_1000 <- 5
c(dmc_yda = dmc_yda, prec_0800 = prec_0800, prec_1000 = prec_1000)
```

1) calculate how much wetting the old daily system would apply for the 24 hour period, given the amount of rain that has happened up until each hour:
```{r}
pr_0800 <- wetting(dmc_yda, prec_0800)
pr_1000 <- wetting(dmc_yda, prec_0800 + prec_1000)
c(pr_0800 = pr_0800, pr_1000 = pr_1000)
```

2) apply to the DMC (ignoring drying for now):
```{r}
dmc_0800 <- dmc_yda + pr_0800
dmc_1000 <- dmc_yda + pr_1000
scenario_2b <- c(dmc_0800 = dmc_0800,  dmc_1000 = dmc_1000)
scenario_2b
```

So now, (ignoring drying), the observed values become  a DMC of `r round(dmc_0800, 1)` at 0800 and a DMC of `r round(dmc_1000, 1)`. The value for 1000 has changed because the observed weather didn't match the forecast, but the value for 0800 remains the same as when it was first calculated.

Consider a more extreme example. Assume the things have proceeded as per the second scenario, but now we have also received 10mm that was not forecast at 1100.
Assume 2mm of rain at 0800, but only 5mm of rain at 1000:
```{r}
prec_0800 <- 2
prec_1000 <- 5
prec_1100 <- 10
c(dmc_yda = dmc_yda, prec_0800 = prec_0800, prec_1000 = prec_1000,
  prec_1100 = prec_1100)
```

1) calculate how much wetting the old daily system would apply for the 24 hour period, given the amount of rain that has happened up until each hour:
```{r}
pr_0800 <- wetting(dmc_yda, prec_0800)
pr_1000 <- wetting(dmc_yda, prec_0800 + prec_1000)
pr_1100 <- wetting(dmc_yda, prec_0800 + prec_1000 + prec_1100)
c(pr_0800 = pr_0800, pr_1000 = pr_1000, pr_1100 = pr_1100)
```

2) apply to the DMC (ignoring drying for now):
```{r}
dmc_0800 <- dmc_yda + pr_0800
dmc_1000 <- dmc_yda + pr_1000
dmc_1100 <- dmc_yda + pr_1100
scenario_3b <- c(dmc_0800 = dmc_0800,  dmc_1000 = dmc_1000, dmc_1100 = dmc_1100)
scenario_3b
```

So in this instance, the weather was exactly the same as scenario 2, up to the point at 1000. And when the 1100 weather comes in, the indices remain the same:
```{r}
data.table::data.table(rbind(c(scenario_1b, dmc_1100=NA),
                             c(scenario_2b, dmc_1100=NA),
                             scenario_3b))
```
Versus what the current proposed method results in:
```{r}
data.table::data.table(rbind(c(scenario_1a, dmc_1100=NA),
                             c(scenario_2a, dmc_1100=NA),
                             scenario_3a))
```

Both methods result in the same value for the final total amount of wetting, but there is no change to values once they are "observed" in method b.

---

This has one noticeable issue - since the canopy interception is being applied as the rain comes in, this means it will always apply to the first rain to happen. So where in the proposed system you would see this if you only got 1.5mm at 0800:
```{r}
prec_0800 <- 1.5
prec_1000 <- 5
c(dmc_yda = dmc_yda, prec_0800 = prec_0800, prec_1000 = prec_1000)
prec_total <- prec_0800 + prec_1000
c(prec_total = prec_total)
pr_total <- wetting(dmc_yda, prec_total)
c(pr_total = pr_total)
proportion_0800 <- prec_0800 / prec_total
proportion_1000 <- prec_1000 / prec_total
c(proportion_0800 = proportion_0800, proportion_1000 = proportion_1000)
pr_0800 <- proportion_0800 * pr_total
pr_1000 <- proportion_1000 * pr_total
c(pr_0800 = pr_0800, pr_1000 = pr_1000)
dmc_0800 <- dmc_yda + pr_0800
dmc_1000 <- dmc_0800 + pr_1000
scenario_2c <- c(dmc_0800 = dmc_0800,  dmc_1000 = dmc_1000)
scenario_2c
```

With what I'm proposing, you wouldn't see any wetting at 0800:
```{r}
prec_0800 <- 1.5
prec_1000 <- 5
c(dmc_yda = dmc_yda, prec_0800 = prec_0800, prec_1000 = prec_1000)
```

1) calculate how much wetting the old daily system would apply for the 24 hour period, given the amount of rain that has happened up until each hour:
```{r}
pr_0800 <- wetting(dmc_yda, prec_0800)
pr_1000 <- wetting(dmc_yda, prec_0800 + prec_1000)
c(pr_0800 = pr_0800, pr_1000 = pr_1000)
```

2) apply to the DMC (ignoring drying for now):
```{r}
dmc_0800 <- dmc_yda + pr_0800
dmc_1000 <- dmc_yda + pr_1000
scenario_2d <- c(dmc_0800 = dmc_0800,  dmc_1000 = dmc_1000)
scenario_2d
```

Again, the final values are the same, but how we got there is a bit different:
```{r}
data.table::data.table(rbind(scenario_2c, scenario_2d))
```

This may result in an odd "spike" in the value at the start of the 24 hour period where the entire canopy interception amount is applied, but I believe that the stability of the indices outweighs that issue.

# Conclusion
There is a way to use the old 24 hour wetting formula that can still produce stable "observed" indices. I make no claims as to the scientific validity, accuracy, or precision of what I am proposing - I am merely saying that there is an option available that I believe can fix the issue I am seeing with indices changing after the fact, that we can use if the trade-offs seem appropriate.

Of course, this is all predicated on my interpretation being that Derek is going to produce hourly drying curves for the DMC and DC - if I am incorrect in this assumption, and we are still using the old daily drying rates and proportioning the drying according to Vapour Pressure Deficit, then we will still see indices changing after the fact - and it will be even worse, because it will fluctuate every time the RH or Temperature isn't exactly as forecast.

This is totally separate from the discussion of whether to use a calendar day (midnight-to-midnight), or a noon-to-noon 24 hour period for the rain. If the indices are not changing after they are "observed", then the period being used has very little impact on anything operationally. If the slight differences that may result from how the rain gets divided between days is acceptable, then using a calendar day should not impact operations any more than staying noon-to-noon - the only difference would be that when calculating indices from the historical data that goes from noon-to-noon, you would potentially get slightly different results than you would if you used hourly data for the same period.

